<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile Editor & Chat Tester</title>
  <meta name="description" content="Profile editor with rich bio, login, fetch, update, and chat send test. Clean UI." />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Quill CSS -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet"/>
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, monospace; }
    .delta-box { background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; font-size: 12px; }
    .error { color: #b91c1c; }
    .success { color: #065f46; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center py-10">
  <div class="max-w-xl w-full space-y-6">
    <div class="bg-white rounded-2xl shadow-lg p-6" id="authCard">
      <h1 class="text-2xl font-bold mb-4 text-center">Profile Editor</h1>
      <div id="loginBlock">
        <form id="loginForm" class="space-y-4">
          <div>
            <label for="identifier" class="block font-medium mb-1">Email or Username</label>
            <input type="text" id="identifier" name="identifier" required autocomplete="username"
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="password" class="block font-medium mb-1">Password</label>
            <input type="password" id="password" name="password" required autocomplete="current-password"
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <button type="submit"
                    class="w-full py-3 rounded-xl font-semibold bg-blue-600 text-white hover:bg-blue-700 transition">
              Log in
            </button>
          </div>
        </form>
        <div class="mt-2 flex justify-between items-center">
          <div id="loginResponse" class="text-sm"></div>
          <div id="tokenDisplay" class="hidden text-xs bg-gray-100 px-3 py-2 rounded-lg mono break-all"></div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6 hidden" id="profileCard">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Edit Profile</h2>
        <div class="flex gap-2">
          <button id="fetchProfileBtn"
                  class="px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            Fetch Profile
          </button>
          <button id="logoutBtn" class="text-sm text-gray-600 underline">Logout</button>
        </div>
      </div>
      <div class="space-y-4">
        <div>
          <div class="font-medium mb-1">Raw profile JSON</div>
          <div id="profileDataRaw" class="delta-box overflow-auto" style="max-height:160px;">Profile JSON will appear here.</div>
        </div>
        <form id="updateProfileForm" class="space-y-5">
          <div class="grid grid-cols-1 gap-4">
            <div>
              <label for="name" class="block font-medium mb-1">Name</label>
              <input type="text" id="name" name="name" placeholder="Full name"
                     class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label for="username" class="block font-medium mb-1">Username</label>
              <input type="text" id="username" name="username" placeholder="username"
                     class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>

          <div>
            <label for="bio" class="block font-medium mb-1">Bio</label>
            <div class="border border-gray-200 rounded-lg">
              <div id="quillEditor" style="min-height:140px;"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1">
              Supports bold, underline, headers, lists, links. Stored as delta. Preview below.
            </div>
            <div class="mt-2">
              <div class="font-medium mb-1">Rendered Bio:</div>
              <div id="bioPreview" class="p-3 bg-gray-50 border rounded-md min-h-[80px]"></div>
            </div>
          </div>

          <div>
            <label for="profileImageUrl" class="block font-medium mb-1">Profile Image URL</label>
            <input type="text" id="profileImageUrl" name="profileImageUrl" placeholder="https://..."
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="openChat" class="block font-medium mb-1">Open Chat</label>
              <select id="openChat" name="openChat"
                      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- keep current --</option>
                <option value="true">True</option>
                <option value="false">False</option>
              </select>
            </div>
            <div>
              <label for="visibility" class="block font-medium mb-1">Visibility</label>
              <select id="visibility" name="visibility"
                      class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- keep current --</option>
                <option value="public">Public</option>
                <option value="private">Private</option>
              </select>
            </div>
          </div>

          <div>
            <label for="status" class="block font-medium mb-1">Status</label>
            <input type="text" id="status" name="status" placeholder="Status message"
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>

          <div>
            <button type="submit"
                    class="w-full py-3 rounded-xl font-semibold bg-blue-600 text-white hover:bg-blue-700 transition">
              Update Profile
            </button>
          </div>
          <div id="updateResponse" class="text-sm"></div>
        </form>
      </div>
    </div>

    <!-- chat test panel -->
    <div class="bg-white rounded-2xl shadow-lg p-6" id="chatCard">
      <h2 class="text-xl font-semibold mb-4">Chat Send Test</h2>
      <div class="space-y-4">
        <div>
          <label for="receiverId" class="block font-medium mb-1">Receiver ID</label>
          <input type="text" id="receiverId" placeholder="UUID of receiver"
                 class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" />
        </div>
        <div>
          <label for="chatMessage" class="block font-medium mb-1">Message</label>
          <textarea id="chatMessage" rows="3" placeholder="Type a message"
                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
        </div>
        <div class="flex gap-2">
          <button id="sendChatBtn"
                  class="px-6 py-3 font-medium bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
            Send Message
          </button>
          <button id="clearChatBtn"
                  class="px-6 py-3 font-medium bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
            Clear
          </button>
        </div>
        <div id="chatResponse" class="text-sm mono overflow-auto" style="max-height:140px;"></div>
      </div>
    </div>
  </div>

  <!-- Quill JS -->
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script>
    let authToken = '';
    const loginForm = document.getElementById('loginForm');
    const loginResponse = document.getElementById('loginResponse');
    const profileCard = document.getElementById('profileCard');
    const fetchProfileBtn = document.getElementById('fetchProfileBtn');
    const profileDataRaw = document.getElementById('profileDataRaw');
    const updateProfileForm = document.getElementById('updateProfileForm');
    const updateResponse = document.getElementById('updateResponse');
    const tokenDisplay = document.getElementById('tokenDisplay');
    const bioPreview = document.getElementById('bioPreview');
    const chatResponse = document.getElementById('chatResponse');
    const receiverInput = document.getElementById('receiverId');
    const chatMessageInput = document.getElementById('chatMessage');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const clearChatBtn = document.getElementById('clearChatBtn');

    const quill = new Quill('#quillEditor', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline', 'strike'],
          [{ header: [1, 2, 3, false] }],
          [{ list: 'ordered' }, { list: 'bullet' }],
          ['link'],
          ['clean']
        ]
      },
      placeholder: 'Write your bio...'
    });

    function showLoginError(msg) {
      loginResponse.textContent = msg;
      loginResponse.className = 'error';
    }
    function showLoginSuccess(msg) {
      loginResponse.textContent = msg;
      loginResponse.className = 'success';
    }
    function showUpdateError(msg) {
      updateResponse.textContent = msg;
      updateResponse.className = 'error';
    }
    function showUpdateSuccess(msg) {
      updateResponse.textContent = msg;
      updateResponse.className = 'success';
    }

    function renderBioPreview(deltaOrHtml) {
      if (typeof deltaOrHtml === 'object') {
        const temp = document.createElement('div');
        const tempQuill = new Quill(temp);
        try {
          tempQuill.setContents(deltaOrHtml);
          bioPreview.innerHTML = tempQuill.root.innerHTML;
        } catch (e) {
          bioPreview.textContent = 'Invalid delta';
        }
      } else if (typeof deltaOrHtml === 'string') {
        bioPreview.innerHTML = deltaOrHtml;
      } else {
        bioPreview.textContent = '';
      }
    }

    // live update preview
    quill.on('text-change', () => {
      renderBioPreview(quill.getContents());
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoginSuccess('Logging in...');
      showLoginError('');
      const identifier = loginForm.identifier.value.trim();
      const password = loginForm.password.value;
      try {
        const res = await fetch('http://localhost:8000/api/login', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ identifier, password }),
        });
        const data = await res.json();
        if (res.ok && data.token) {
          authToken = data.token;
          showLoginSuccess('Login successful.');
          tokenDisplay.textContent = authToken;
          tokenDisplay.classList.remove('hidden');
          profileCard.classList.remove('hidden');
        } else {
          showLoginError(data.error || 'Login failed.');
        }
      } catch (err) {
        showLoginError('Network error.');
      }
    });

    fetchProfileBtn.addEventListener('click', async () => {
      if (!authToken) return;
      profileDataRaw.textContent = 'Loading...';
      try {
        const res = await fetch('http://localhost:8000/api/profile', {
          headers: { 'Authorization': 'Bearer ' + authToken },
        });
        const data = await res.json();
        if (res.ok && data.user) {
          const u = data.user;
          profileDataRaw.textContent = JSON.stringify(u, null, 2);
          document.getElementById('name').value = u.name || '';
          document.getElementById('username').value = u.username || '';
          document.getElementById('profileImageUrl').value = u.profileImageUrl || '';
          document.getElementById('status').value = u.status || '';
          document.getElementById('visibility').value = u.visibility || '';
          document.getElementById('openChat').value = (u.openChat === true) ? 'true' : (u.openChat === false ? 'false' : '');

          if (u.bio) {
            if (typeof u.bio === 'object' && u.bio.ops) {
              quill.setContents(u.bio);
              renderBioPreview(u.bio);
            } else if (typeof u.bio === 'string') {
              quill.clipboard.dangerouslyPasteHTML(u.bio);
              renderBioPreview(u.bio);
            } else {
              quill.setText('');
              renderBioPreview('');
            }
          } else {
            quill.setText('');
            renderBioPreview('');
          }
        } else {
          profileDataRaw.textContent = data.error || 'Failed to load profile';
        }
      } catch (err) {
        profileDataRaw.textContent = 'Network error.';
      }
    });

    updateProfileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      showUpdateError('');
      showUpdateSuccess('Updating...');
      if (!authToken) { showUpdateError('Not authenticated'); return; }

      const payload = {};
      const name = document.getElementById('name').value.trim();
      if (name) payload.name = name;
      const username = document.getElementById('username').value.trim();
      if (username) payload.username = username;
      payload.bio = quill.getContents();
      const profileImageUrl = document.getElementById('profileImageUrl').value.trim();
      if (profileImageUrl) payload.profileImageUrl = profileImageUrl;
      const openChatVal = document.getElementById('openChat').value;
      if (openChatVal === 'true') payload.openChat = true;
      else if (openChatVal === 'false') payload.openChat = false;
      const status = document.getElementById('status').value.trim();
      if (status) payload.status = status;
      const visibility = document.getElementById('visibility').value;
      if (visibility) payload.visibility = visibility;

      try {
        const res = await fetch('http://localhost:8000/api/update', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + authToken,
          },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (res.ok) {
          showUpdateSuccess(data.message || 'Profile updated.');
          setTimeout(() => fetchProfileBtn.click(), 400);
        } else {
          showUpdateError(data.message || 'Update failed.');
        }
      } catch (err) {
        showUpdateError('Network error.');
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      authToken = '';
      profileCard.classList.add('hidden');
      loginForm.reset();
      updateProfileForm.reset();
      profileDataRaw.textContent = '';
      quill.setText('');
      bioPreview.textContent = '';
      loginResponse.textContent = '';
      tokenDisplay.classList.add('hidden');
      chatResponse.textContent = '';
      receiverInput.value = '';
      chatMessageInput.value = '';
    });

    sendChatBtn.addEventListener('click', async () => {
      chatResponse.textContent = '';
      if (!authToken) {
        chatResponse.textContent = 'not authenticated';
        chatResponse.className = 'error';
        return;
      }
      const receiverId = receiverInput.value.trim();
      const message = chatMessageInput.value.trim();
      if (!receiverId || !message) {
        chatResponse.textContent = 'receiverId and message required';
        chatResponse.className = 'error';
        return;
      }

      try {
        const res = await fetch('http://localhost:8000/api/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + authToken,
          },
          body: JSON.stringify({ receiverId, message }),
        });
        const data = await res.json();
        if (res.ok) {
          chatResponse.textContent = JSON.stringify(data, null, 2);
          chatResponse.className = 'success';
        } else {
          chatResponse.textContent = data.error || data.message || 'send failed';
          chatResponse.className = 'error';
        }
      } catch (err) {
        chatResponse.textContent = 'network error';
        chatResponse.className = 'error';
      }
    });

    clearChatBtn.addEventListener('click', () => {
      receiverInput.value = '';
      chatMessageInput.value = '';
      chatResponse.textContent = '';
    });
  </script>
</body>
</html>
